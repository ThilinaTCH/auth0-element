<link rel="import" href="../polymer/polymer-element.html">

<link rel="import" href="auth0.html">
<link rel="import" href="auth0-lock.html">

<dom-module id="auth0-auth">

  <template>
  </template>

  <script>
    class Auth0Auth extends Polymer.Element {
      static get is() { return 'auth0-auth'; }
      static get properties() {
        return {
          clientId: {
            type: String
          },
          domain: {
            type: String
          },
          options: {
            type: Object
          },
          logoutRedirectTo: {
            type: String
          },
          userProfile: {
            readOnly: true,
            notify: true,
            type: Object
          },
          /**
           * A pointer to the auth0 instance being used by the element.
           */
          auth0: {
            type: Object,
            readOnly: true
          },
          localStorageKey: {
            type: String,
            readOnly: true,
            value: "auth0:authUser"
          },
          idToken: {
            type: String,
            readOnly: true,
            notify: true
          },
          hostedPages: {
            type: Boolean,
            value: false
          }
        }
      }

      static get observers() {
        return [
          '_setLocalStorage(localStorageKey, idToken)',
          '_init(clientId, domain, options)'
        ]
      }

      _init(clientId, domain, options) {
        if(clientId !== undefined && domain !== undefined && options !== undefined) {
          // instantiate Lock
          this._setAuth0(new auth0.WebAuth({
                domain:       domain,
                clientID:     clientId
              })
          );

          this._parseHash();
        }
      }

      _setLocalStorage(localStorageKey, idToken) {
      var value = this.idToken;
      localStorage.setItem(this.localStorageKey, value);
      }

      _parseHash() {
        var idToken = localStorage.getItem('auth0:authUser');
        var accessToken = localStorage.getItem('auth0:accessToken');

        if (idToken && accessToken) {
          this.auth0.client.userInfo(accessToken, function(err, user) {
            this._setUserProfile(user);
          }.bind(this));
          return
        }

        this.auth0.parseHash(window.location.hash, function(err, authResult) {
          if (authResult && authResult.accessToken && authResult.idToken) {
            this.auth0.client.userInfo(authResult.accessToken, function(err, user) {
              this._setUserProfile(user);
            }.bind(this));
            window.location.hash = '';
            localStorage.setItem('auth0:authUser', authResult.idToken);
            localStorage.setItem('auth0:accessToken', authResult.accessToken);
            return
          } else {
            // user is not logged, check whether there is an SSO session or not
  //              this.auth0.renewAuth({scope: (options.auth && options.auth.params && options.auth.params.scope) || 'openid'}, function(err, data) {
            this.auth0.getSSOData(function(err, data) {
              if (!err && data.sso) {
                // there is! redirect to Auth0 for SSO
                this.auth0.signin({
                  // If the user wanted to go to some other URL, you can track it with `state`
                  state: this.getQueryParameter('targetUrl'),
                  callbackOnLocationHash: true,
                  scope: (options.auth && options.auth.params && options.auth.params.scope) || 'openid'
                });
              } else {
                // regular login
                if(this.hostedPages) {
                  this.auth0.authorize(this.options.auth);
                  return
                }
                //else
                var lock = new Auth0Lock(this.clientId, this.domain, this.options);
                lock.show();
              }
            }.bind(this));
          }
        }.bind(this));
      }

      _getProfile(idToken) {
        this.auth0.getProfile(idToken, function (err, profile) {
          if (err) {
            this.signOut(this.clientId);
          }
          this._setUserProfile(profile);
        }.bind(this));
      }

      signOut(clientId) {
        localStorage.removeItem(this.localStorageKey);
        this.auth0.logout({returnTo: this.logoutRedirectTo, client_id: clientId}, {version: 'v2'});
      }
    };
    customElements.define(Auth0Auth.is, Auth0Auth);
  </script>
</dom-module>
